<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
</head>
<body style="overflow: auto">
  <!-- include latest SDK version -->
  <script src="https://unpkg.com/@aeternity/aepp-sdk/dist/aepp-sdk.browser-script.js"></script>
  <script type="text/javascript">
    const my_contract = 
`
contract Emin =

    record state = { 
        currentQuestionID: int,
        testvalue: int,
        questions: map(int, question),
        right_answer: map(int, string),
        participants: list(address),
        game_started: bool,
        game_stopped: bool
        }

    record question = {
        text: string,
        id: int,
        answers: list(string)
        }

    stateful entrypoint init() = {
        testvalue = 42,
        currentQuestionID = 1,
        participants = [],
        game_started = false,
        game_stopped = false,
        questions = 
        {
            [1] = {
                id = 1,
                text =  "What is the capital of Uruguay",
                answers = ["Montevideo", "Vaduz", "Berlin", "New York"]
            }
        },
        right_answer = { [1] = "Montevideo" }
        }

    stateful entrypoint make_answer(q_id:int, answer:string) : option(question) =
        require(state.game_stopped == false, "Sorry, game over")
        require(state.game_started == true, "Sorry, game has not started")
        if(!is_this_the_right_answer(q_id, answer))
            let the_better_players = delete_from_partipants(Call.caller, state.participants)
            put(state{participants = the_better_players})
            None
        else
            if(Map.size(state.questions) == q_id)
                put(state{game_stopped = true})
                Chain.spend(Call.caller, Contract.balance)
                Some(state.questions[q_id])
            else
                Some(state.questions[q_id+1])
            
    
    function delete_from_partipants(participant:address, participants: list(address)) : list(address) =
        switch (participants)
            [] => []
            first_element :: rest_participants =>
                if(first_element == participant)
                    rest_participants
                else
                    delete_from_partipants(participant, rest_participants)

    
    public entrypoint is_this_the_right_answer(id: int,answer: string) : bool =
        state.right_answer[id] == answer

    stateful entrypoint add_question(question: string, right: string, all: list(string)) =
        require(Call.caller == Contract.creator, "You are not the Boss.")
        let next_id = state.currentQuestionID + 1
        put(state{
            currentQuestionID = next_id,
            questions[next_id] = {text = question, id = next_id, answers = all},
            right_answer[next_id] = right 
            })
    
    stateful entrypoint register() : bool =
        require(state.game_started == false, "Game already started")
        require(Call.value == 1000000000000000000, "Not enough tokens")
        if (check_if_registered(state.participants) == false)
            put(state{participants = Call.caller :: state.participants})
            true
        else
            false

    function check_if_registered(participants: list(address)) : bool =
        switch (participants)
            [] => false
            element :: rest_of_list => 
                if (element == Call.caller)
                    true
                else
                    check_if_registered(rest_of_list)

    stateful entrypoint start_game() = 
        put(state{game_started = true})
    
    entrypoint is_game_started() : bool =
        state.game_started

    public entrypoint get_question(id: int) : question =
        state.questions[id] 
    
    public entrypoint read_test_value() : int =
        state.testvalue
    
    public entrypoint get_owner() : address =
        Contract.creator
    
    public entrypoint return_caller() : address =
        Call.caller

    public stateful entrypoint add_test_value(new_testvalue: int) : int =
        put(state{testvalue = new_testvalue}) 
        new_testvalue
`

    let my_aepp
    let contract
    let already_registered = false
    let current_question_id = 1
    let interval_id
    let questions_array = []

    async function start_aepp() {
        my_aepp = await Ae.Aepp()
        const block_height = await my_aepp.height()
        console.log(block_height)
        const user_address = await my_aepp.address()
        console.log(user_address)
        //document.getElementById('log').innerHTML = user_address
        contract = await my_aepp.getContractInstance(my_contract)
        //const {decodedResult:value_from_json} = await contract.methods.read_test_value()
        //console.log("Async await style result: " + value_from_json)
        //document.getElementById('static_result').innerHTML = value_from_json
    }

    async function join_game() {
        const contractAddress = document.getElementById("join_game").value
        if (contractAddress && Ae.Crypto.assertedType(contractAddress, "ct")){
            contract = await my_aepp.getContractInstance(my_contract, {contractAddress})
            console.log("contract loaded")
            console.log((await contract.methods.is_game_started()).decodedResult)
        }
        else {
            console.log("No address")
        }
    }

    async function create_game() { 
        await contract.deploy()
        document.getElementById("game_id").value = "http://aepp.earlycrypto.com?g_id="+contract.deployInfo.address
    }

    start_aepp().catch(error => console.log(error))

    async function magic_function() {
          const new_number = document.getElementById('new_number_baby').value
          console.log(new_number)
          // destuction of object best way (first way)
          //const {decodedResult:put_value} = await contract.methods.add_test_value(new_number);
          // second way
          const put_value_again = (await contract.methods.add_test_value(new_number)).decodedResult
          // third way
          //const put_value_again_again = await contact.methods.add_test_value(new_number);
          //console.log(put_value_again_again.decodedResult);
          document.getElementById('static_result').innerHTML = put_value_again
      }

      async function get_question() {
          const get_q = (await contract.methods.get_question(1)).decodedResult.text
          console.log(get_q)
      }

      async function register() {
          await contract.methods.register({amount:"1000000000000000000"})
          already_registered = true
          document.getElementById("just_register").style.visibility = 'hidden'
          await check_if_game_started()
      }

      async function add_q() {
          const question = document.getElementById("question").value
          questions_array.push(question)
          const answers = [1,2,3,4].map(id=>document.getElementById("answer"+id).value)
          const right_answer = document.getElementById("right_answer").value
          //debugger 
          await contract.methods.add_question(question,right_answer,answers)
          document.getElementById("question").value = ""
          document.getElementById("right_answer").value = ""
          document.getElementById("answer1").value = ""
          document.getElementById("answer2").value = ""
          document.getElementById("answer3").value = ""
          document.getElementById("answer4").value = ""
         // [1,2,3,4].forEach(id=>document.getElementById("answer"+id).value = "")
         console.log(questions_array)
          
      }

      async function start_game() {
          await contract.methods.start_game()
          console.log("Game Started!")
      }

      async function check_if_game_started(){
          interval_id = setInterval(async()=>{
            if((await contract.methods.is_game_started()).decodedResult){
                await get_first_question()
            }
          }, 5000)
      }

      async function get_first_question(){
        clearInterval(interval_id)
        const q1 = (await contract.methods.get_question(1)).decodedResult
        document.getElementById("display_question").innerHTML = q1.text
        document.getElementById("a1").innerHTML = q1.answers[0]
        document.getElementById("a2").innerHTML = q1.answers[1]
        document.getElementById("a3").innerHTML = q1.answers[2]
        document.getElementById("a4").innerHTML = q1.answers[3]
      }

      async function submit_answer(event){
        console.log(event)
        
        const next_question = (await contract.methods.make_answer(current_question_id, event.textContent)).decodedResult
        console.log(next_question)

        if(!next_question){
            console.log("You loose")
        }
        else if(next_question.id === current_question_id){
            console.log("You are the winner")
        }
        else {
        current_question_id = next_question.id
        document.getElementById("display_question").innerHTML = next_question.text
        document.getElementById("a1").innerHTML = next_question.answers[0]
        document.getElementById("a2").innerHTML = next_question.answers[1]
        document.getElementById("a3").innerHTML = next_question.answers[2]
        document.getElementById("a4").innerHTML = next_question.answers[3]
        }

      }


      function copy_game_id() {
        var copyText = document.getElementById("game_id");
        copyText.select();
        copyText.setSelectionRange(0, 99999)
        document.execCommand("copy");
        alert("Copied the text: " + copyText.value);
        }

  </script>

<!--
Hello world?!
<div id="log">Show my address here</div>

<div id="static_result">Tell me</div>

Change the magic number
<input type="number" id="new_number_baby">
<button id="magic_button" onclick="magic_function()">Do it</button>
-->


<h4>Create Game</h4>
<button onclick="create_game()">Create Game</button>
<input id="game_id"><button onclick="copy_game_id()">Copy</button>   

<h4>Join Game</h4>
<input id="join_game">
<button onclick="join_game()">Join Game</button>

<h4>Add Question</h4>
<input id="question" placeholder="What is the question?">
<input id="answer1" placeholder="1st answer option">
<input id="answer2" placeholder="2nd answer option">
<input id="answer3" placeholder="3rd answer option">
<input id="answer4" placeholder="4th answer option">
<input id="right_answer" placeholder="What is the right answer?">
<button id="add_q" onclick="add_q()">Add Question</button>


<br>
<b>Register</b>
<br>
<button id="start_game" onclick="start_game()">Start Game</button>

<br>
<b>Register</b>
<br>

<button id="just_register" onclick="register()">Register</button>

<br>
<b>Play Game</b>
<br>

<div id="display_question">???</div>
<button id="a1" onclick="submit_answer(this)">1</button>
<button id="a2" onclick="submit_answer(this)">2</button>
<button id="a3" onclick="submit_answer(this)">3</button>
<button id="a4" onclick="submit_answer(this)">4</button>


</body>
</html>
