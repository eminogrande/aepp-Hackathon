<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <style>
        /* Absolute Center Spinner */
        .loading {
            position: fixed;
            z-index: 999;
            height: 2em;
            width: 2em;
            overflow: visible;
            margin: auto;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
        }

        /* Transparent Overlay */
        .loading:before {
            content: '';
            display: block;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.3);
        }

        /* :not(:required) hides these rules from IE9 and below */
        .loading:not(:required) {
            /* hide "loading..." text */
            font: 0/0 a;
            color: transparent;
            text-shadow: none;
            background-color: transparent;
            border: 0;
        }

        .loading:not(:required):after {
            content: '';
            display: block;
            font-size: 10px;
            width: 1em;
            height: 1em;
            margin-top: -0.5em;
            -webkit-animation: spinner 1500ms infinite linear;
            -moz-animation: spinner 1500ms infinite linear;
            -ms-animation: spinner 1500ms infinite linear;
            -o-animation: spinner 1500ms infinite linear;
            animation: spinner 1500ms infinite linear;
            border-radius: 0.5em;
            -webkit-box-shadow: rgba(0, 0, 0, 0.75) 1.5em 0 0 0, rgba(0, 0, 0, 0.75) 1.1em 1.1em 0 0, rgba(0, 0, 0, 0.75) 0 1.5em 0 0, rgba(0, 0, 0, 0.75) -1.1em 1.1em 0 0, rgba(0, 0, 0, 0.5) -1.5em 0 0 0, rgba(0, 0, 0, 0.5) -1.1em -1.1em 0 0, rgba(0, 0, 0, 0.75) 0 -1.5em 0 0, rgba(0, 0, 0, 0.75) 1.1em -1.1em 0 0;
            box-shadow: rgba(0, 0, 0, 0.75) 1.5em 0 0 0, rgba(0, 0, 0, 0.75) 1.1em 1.1em 0 0, rgba(0, 0, 0, 0.75) 0 1.5em 0 0, rgba(0, 0, 0, 0.75) -1.1em 1.1em 0 0, rgba(0, 0, 0, 0.75) -1.5em 0 0 0, rgba(0, 0, 0, 0.75) -1.1em -1.1em 0 0, rgba(0, 0, 0, 0.75) 0 -1.5em 0 0, rgba(0, 0, 0, 0.75) 1.1em -1.1em 0 0;
        }

        /* Animation */

        @-webkit-keyframes spinner {
            0% {
                -webkit-transform: rotate(0deg);
                -moz-transform: rotate(0deg);
                -ms-transform: rotate(0deg);
                -o-transform: rotate(0deg);
                transform: rotate(0deg);
            }
            100% {
                -webkit-transform: rotate(360deg);
                -moz-transform: rotate(360deg);
                -ms-transform: rotate(360deg);
                -o-transform: rotate(360deg);
                transform: rotate(360deg);
            }
        }
        @-moz-keyframes spinner {
            0% {
                -webkit-transform: rotate(0deg);
                -moz-transform: rotate(0deg);
                -ms-transform: rotate(0deg);
                -o-transform: rotate(0deg);
                transform: rotate(0deg);
            }
            100% {
                -webkit-transform: rotate(360deg);
                -moz-transform: rotate(360deg);
                -ms-transform: rotate(360deg);
                -o-transform: rotate(360deg);
                transform: rotate(360deg);
            }
        }
        @-o-keyframes spinner {
            0% {
                -webkit-transform: rotate(0deg);
                -moz-transform: rotate(0deg);
                -ms-transform: rotate(0deg);
                -o-transform: rotate(0deg);
                transform: rotate(0deg);
            }
            100% {
                -webkit-transform: rotate(360deg);
                -moz-transform: rotate(360deg);
                -ms-transform: rotate(360deg);
                -o-transform: rotate(360deg);
                transform: rotate(360deg);
            }
        }
        @keyframes spinner {
            0% {
                -webkit-transform: rotate(0deg);
                -moz-transform: rotate(0deg);
                -ms-transform: rotate(0deg);
                -o-transform: rotate(0deg);
                transform: rotate(0deg);
            }
            100% {
                -webkit-transform: rotate(360deg);
                -moz-transform: rotate(360deg);
                -ms-transform: rotate(360deg);
                -o-transform: rotate(360deg);
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body style="overflow: auto">
<!-- include latest SDK version -->
<script src="https://unpkg.com/@aeternity/aepp-sdk/dist/aepp-sdk.browser-script.js"></script>
<script src="gameContract.js"></script>
<script type="text/javascript">

    let my_aepp
    let contract
    let already_registered = false
    let current_question_id = 1
    let interval_id
    let questions_array = []
    let the_participants
    let another_interval_id
    let is_owner = false

    async function start_aepp() {
        my_aepp = await Ae.Aepp()
        const block_height = await my_aepp.height()
        console.log(block_height)
        const user_address = await my_aepp.address()
        console.log(user_address)
        contract = await my_aepp.getContractInstance(my_contract)

        var url = new URL(location.href);
        var gid = url.searchParams.get("g_id");
        console.log(gid);

        if (gid != "") {
            const contractAddress = gid
            if (contractAddress && Ae.Crypto.assertedType(contractAddress, "ct")) {
                contract = await my_aepp.getContractInstance(my_contract, {contractAddress})
                console.log("contract loaded")
                displayElement("game_creator", false)
                displayElement("just_register", true)

                contract.methods.is_game_started().then(is_started => {
                    if (is_started) {
                        displayElement("just_register", false)
                        document.getElementById("game_status").innerHtml = 'Sorry game is already started'
                    }
                })

                contract.methods.is_game_stopped().then(is_game_stopped => {
                    if (is_game_stopped) {
                        displayElement("just_register", false)
                        document.getElementById("game_status").innerHtml = 'Game is already finished'
                    }
                })

            } else {
                console.log("No address")
            }
        }
    }

    start_aepp().then(() => {
        displayElement('loader', false)
    }).catch(error => {
        displayElement('loader', false)
        console.log(error)
    })

    async function create_game() {
        displayElement('loader', true)
        await contract.deploy()
        displayElement('loader', false)
        is_owner = true
        console.log("Contract deployed!")
        document.getElementById("game_id").value = "https://aepp.earlycrypto.com?g_id=" + contract.deployInfo.address
        get_registered_players()
        displayElement("hide_until_started", true)
    }

    function displayElement (elIdorIds, v) {
        if (typeof elIdorIds === 'string') {
            document.getElementById(elIdorIds).style.display = v ? 'block' : 'none'
        }
        if (Array.isArray(elIdorIds)) {
            elIdorIds.forEach(elId => {
                document.getElementById(elId).style.display = v ? 'block' : 'none'
            })
        }
    }

    async function register() {
        displayElement('loader', true)
        await contract.methods.register({amount: "1000000000000000000"})
        displayElement('loader', false)
        already_registered = true
        displayElement("just_register", false)
        check_if_game_started()
        if (!is_owner) get_registered_players()
    }

    async function add_q() {
        const question = document.getElementById("question").value
        questions_array.push(question)
        const answers = [1, 2, 3, 4].map(id => document.getElementById("answer" + id).value)
        const right_answer = document.getElementById("right_answer").value
        //debugger
        displayElement('loader', true)
        await contract.methods.add_question(question, right_answer, answers)
        displayElement('loader', false)
        document.getElementById("question").value = ""
        document.getElementById("right_answer").value = ""
        document.getElementById("answer1").value = ""
        document.getElementById("answer2").value = ""
        document.getElementById("answer3").value = ""
        document.getElementById("answer4").value = ""
        // [1,2,3,4].forEach(id=>document.getElementById("answer"+id).value = "")
        console.log(questions_array)
        document.getElementById("added_questions").innerHTML = questions_array

    }

    async function start_game() {
        displayElement('loader', true)
        await contract.methods.start_game()
        displayElement('loader', false)
        console.log("Game Started!")
        clearInterval(another_interval_id)
        displayElement("game_creator", false)
    }

    async function check_if_game_started() {
        interval_id = setInterval(async () => {
            if ((await contract.methods.is_game_started()).decodedResult) {
                displayElement("play_game", true)
                await get_first_question()
            }
        }, 5000)
    }

    async function get_registered_players() {
        another_interval_id = setInterval(async () => {
            const part = (await contract.methods.return_participants()).decodedResult
            the_participants = part.length
            document.getElementById("already_participating").innerHTML = the_participants
        }, 5000)
    }

    async function get_first_question() {
        displayElement('loader', true)
        clearInterval(interval_id)
        clearInterval(another_interval_id)
        const q1 = (await contract.methods.get_question(1)).decodedResult
        document.getElementById("display_question").innerHTML = q1.text
        document.getElementById("a1").innerHTML = q1.answers[0]
        document.getElementById("a2").innerHTML = q1.answers[1]
        document.getElementById("a3").innerHTML = q1.answers[2]
        document.getElementById("a4").innerHTML = q1.answers[3]
        displayElement('loader', false)
    }

    async function submit_answer(event) {
        displayElement('loader', true)
        try {
            const next_question = (await contract.methods.make_answer(current_question_id, event.textContent)).decodedResult
            console.log(next_question)

            if (!next_question) {
                console.log("You loose")
                document.getElementById("game_status").innerHTML = 'You lose'
                displayElement("play_game", false)
            } else if (next_question.id === current_question_id) {
                console.log("You are the winner")
                document.getElementById("game_status").innerHTML = 'You are the winner'
            } else {
                current_question_id = next_question.id
                document.getElementById("display_question").innerHTML = next_question.text
                document.getElementById("a1").innerHTML = next_question.answers[0]
                document.getElementById("a2").innerHTML = next_question.answers[1]
                document.getElementById("a3").innerHTML = next_question.answers[2]
                document.getElementById("a4").innerHTML = next_question.answers[3]
            }
            displayElement('loader', false)
        } catch (e) {
            document.getElementById("game_status").innerHTML = e.decodedError
            displayElement('loader', false)
        }
    }


    function copy_game_id() {
        var copyText = document.getElementById("game_id");
        copyText.select();
        copyText.setSelectionRange(0, 99999)
        document.execCommand("copy");
        alert("Copied the text: " + copyText.value);
    }


</script> 


<h1>CQ Trivia</h1>
<div id="hide_everything">

    <button id="just_register" onclick="register()" style="display: none">Click here to register</button>
    <br>
    Registered players: <h1><div id="already_participating">0</div></h1>

    <hr>

    <div id="play_game" style="display: none">
        <h4>Play Game</h4>
        <div id="display_question">???</div>
        <button id="a1" onclick="submit_answer(this)">1</button>
        <button id="a2" onclick="submit_answer(this)">2</button>
        <button id="a3" onclick="submit_answer(this)">3</button>
        <button id="a4" onclick="submit_answer(this)">4</button>
    </div>
    <div id="game_status"></div>

    <div id="game_creator">
     <center>   <button onclick="create_game()">Create Game</button></center>
     <div id="hide_until_started" style="display: none">
        <input id="game_id">
        <button onclick="copy_game_id()">Copy</button>
       
       
        
    <h4>Add questions</h4>
        <input id="question" placeholder="What is the question?">
        <input id="answer1" placeholder="1st answer option">
        <input id="answer2" placeholder="2nd answer option">
        <input id="answer3" placeholder="3rd answer option">
        <input id="answer4" placeholder="4th answer option">
        <input id="right_answer" placeholder="What is the right answer?">
        <button id="add_q" onclick="add_q()">Add Question</button>

        <br>
    <b>Added questions:</b>
        <div id="added_questions"></div>

    <br>
        <button id="start_game" onclick="start_game()">Start Game</button>
    </div>
</div>

</div>
<div id="loader" class="loading">Loading&#8230;</div>

</body>
</html>
